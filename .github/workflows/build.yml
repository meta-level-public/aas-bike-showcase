name: Build

on:
  push:
    branches: [main, docker-setup]
  pull_request:
    branches: [main, docker-setup]

jobs:
  validate:
    name: Validate (format)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Install npm dependencies
        run: npm ci
      - name: Check formatting
        run: npm run format:check

  test:
    name: Test (.NET)
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Restore dependencies
        run: dotnet restore src/AasDemoapp/AasDemoapp.csproj
      - name: Build
        run: dotnet build src/AasDemoapp/AasDemoapp.csproj --no-restore --configuration Release
      - name: Test
        run: dotnet test tests/AasDemoapp.Tests/AasDemoapp.Tests.csproj --verbosity normal

  build_demoapp_image:
    name: Build Docker image
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Set Docker image tag
        id: set_tag
        run: |
          if [ "$GITHUB_REF_NAME" = "main" ]; then
            echo "tag=aasdemoapp:latest" >> $GITHUB_OUTPUT
          else
            echo "tag=aasdemoapp:preview" >> $GITHUB_OUTPUT
          fi
      - name: Build Docker image using PowerShell script
        run: pwsh -File build-scripts/build.ps1 -Configuration Release -Target final -Tag ${{ steps.set_tag.outputs.tag }}
        shell: pwsh
        working-directory: ${{ github.workspace }}

      - name: Login to GitHub Container Registry
        run: echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Tag Docker image for GHCR
        run: |
          if [ "${{ steps.set_tag.outputs.tag }}" = "aasdemoapp:latest" ]; then
            docker tag aasdemoapp:latest ghcr.io/${{ github.repository_owner }}/aasdemoapp:latest
          else
            docker tag aasdemoapp:preview ghcr.io/${{ github.repository_owner }}/aasdemoapp:preview
          fi

      - name: Push Docker image to GHCR
        run: |
          if [ "${{ steps.set_tag.outputs.tag }}" = "aasdemoapp:latest" ]; then
            docker push ghcr.io/${{ github.repository_owner }}/aasdemoapp:latest
          else
            docker push ghcr.io/${{ github.repository_owner }}/aasdemoapp:preview
          fi

  build_proxy_image:
    name: Build Docker image
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Set Docker image tag
        id: set_tag
        run: |
          if [ "$GITHUB_REF_NAME" = "main" ]; then
            echo "tag=aasdemoproxy:latest" >> $GITHUB_OUTPUT
          else
            echo "tag=aasdemoproxy:preview" >> $GITHUB_OUTPUT
          fi
      - name: Build Docker image using PowerShell script
        run: pwsh -File build-scripts/build.ps1 -Configuration Release -Target final -Tag ${{ steps.set_tag.outputs.tag }} -Dockerfile Dockerfile.Proxy
        shell: pwsh
        working-directory: ${{ github.workspace }}

      - name: Login to GitHub Container Registry
        run: echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Tag Docker image for GHCR
        run: |
          if [ "${{ steps.set_tag.outputs.tag }}" = "aasdemoproxy:latest" ]; then
            docker tag aasdemoproxy:latest ghcr.io/${{ github.repository_owner }}/aasdemoproxy:latest
          else
            docker tag aasdemoproxy:preview ghcr.io/${{ github.repository_owner }}/aasdemoproxy:preview
          fi

      - name: Push Docker image to GHCR
        run: |
          if [ "${{ steps.set_tag.outputs.tag }}" = "aasdemoproxy:latest" ]; then
            docker push ghcr.io/${{ github.repository_owner }}/aasdemoproxy:latest
          else
            docker push ghcr.io/${{ github.repository_owner }}/aasdemoproxy:preview
          fi

  build_landingpage_image:
    name: Build Landing Page Docker image
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set Docker image tag
        id: set_tag
        run: |
          if [ "$GITHUB_REF_NAME" = "main" ]; then
            echo "tag=landing-page:latest" >> $GITHUB_OUTPUT
          else
            echo "tag=landing-page:preview" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker image
        working-directory: src/LandingPage
        run: |
          if [ "${{ steps.set_tag.outputs.tag }}" = "landing-page:latest" ]; then
            docker build -t landing-page:latest .
          else
            docker build -t landing-page:preview .
          fi

      - name: Login to GitHub Container Registry
        run: echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Tag Docker image for GHCR
        run: |
          if [ "${{ steps.set_tag.outputs.tag }}" = "landing-page:latest" ]; then
            docker tag landing-page:latest ghcr.io/${{ github.repository_owner }}/landing-page:latest
          else
            docker tag landing-page:preview ghcr.io/${{ github.repository_owner }}/landing-page:preview
          fi

      - name: Push Docker image to GHCR
        run: |
          if [ "${{ steps.set_tag.outputs.tag }}" = "landing-page:latest" ]; then
            docker push ghcr.io/${{ github.repository_owner }}/landing-page:latest
          else
            docker push ghcr.io/${{ github.repository_owner }}/landing-page:preview
          fi
