name: Build

on:
  push:
    branches: [main, docker-setup]
  pull_request:
    branches: [main, docker-setup]

jobs:
  # validate:
  #   name: Validate (format)
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #     - name: Install npm dependencies
  #       run: npm ci
  #     - name: Check formatting
  #       run: npm run format:check

  # test:
  #   name: Test (.NET)
  #   runs-on: ubuntu-latest
  #   needs: validate
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Setup .NET
  #       uses: actions/setup-dotnet@v4
  #       with:
  #         dotnet-version: '9.0.x'
  #     - name: Restore dependencies
  #       run: dotnet restore src/AasDemoapp.csproj
  #     - name: Build
  #       run: dotnet build src/AasDemoapp.csproj --no-restore --configuration Release
  #     - name: Test
  #       run: dotnet test tests/AasDemoapp.Tests.csproj --verbosity normal

  build_image:
    name: Build Docker image
    runs-on: ubuntu-latest
    # needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Set Docker image tag
        id: set_tag
        run: |
          if [ "$GITHUB_REF_NAME" = "main" ]; then
            echo "tag=aasdemoapp:latest" >> $GITHUB_OUTPUT
          else
            echo "tag=aasdemoapp:preview" >> $GITHUB_OUTPUT
          fi
      - name: Build Docker image using PowerShell script
        run: pwsh -File build-scripts/build.ps1 -Configuration Release -Target final -Tag ${{ steps.set_tag.outputs.tag }}
        shell: pwsh
        working-directory: ${{ github.workspace }}

      # Steps for GitHub Container Registry (ghcr.io):
      # - name: Login to GitHub Container Registry
      #   run: echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # - name: Tag Docker image for GHCR
      #   run: docker tag aasdemoapp:latest ghcr.io/${{ github.repository_owner }}/aasdemoapp:latest

      # - name: Push Docker image to GHCR
      #   run: docker push ghcr.io/${{ github.repository_owner }}/aasdemoapp:latest
